name: Build Standalone Environment

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      python_version:
        description: "Python version (e.g. 3.12.12)"
        required: true
        default: "3.13.12"
      pbs_release:
        description: "python-build-standalone release tag (e.g. 20260211)"
        required: true
        default: "20260211"
      comfyui_ref:
        description: "ComfyUI branch/tag (leave empty for latest stable release)"
        required: false
        default: ""
      release_tag:
        description: "Tag for the GitHub Release to upload to"
        required: true
        default: "standalone-v0.1.0"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows
          - id: win-nvidia
            os: windows-latest
            python_platform: x86_64-pc-windows-msvc
            vendor_requirements: requirements-nvidia.txt
          # - id: win-nvidia-cu128
          #   os: windows-latest
          #   python_platform: x86_64-pc-windows-msvc
          #   vendor_requirements: requirements-nvidia-cu128.txt
          # - id: win-nvidia-cu126
          #   os: windows-latest
          #   python_platform: x86_64-pc-windows-msvc
          #   vendor_requirements: requirements-nvidia-cu126.txt
          - id: win-intel-xpu
            os: windows-latest
            python_platform: x86_64-pc-windows-msvc
            vendor_requirements: requirements-intel.txt
          # AMD universal ROCm 7.2 package only provides Python 3.12 wheels
          - id: win-amd
            os: windows-latest
            python_platform: x86_64-pc-windows-msvc
            vendor_requirements: requirements-amd-win.txt
            python_version: "3.12.12"
          - id: win-cpu
            os: windows-latest
            python_platform: x86_64-pc-windows-msvc
            vendor_requirements: requirements-cpu.txt
          # Linux
          # - id: linux-nvidia
          #   os: ubuntu-latest
          #   python_platform: x86_64-unknown-linux-gnu
          #   vendor_requirements: requirements-nvidia.txt
          # macOS
          - id: mac-mps
            os: macos-latest
            python_platform: aarch64-apple-darwin
            vendor_requirements: requirements-mac.txt

    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.id }}

    steps:
      - name: Checkout launcher repo
        uses: actions/checkout@v4

      - name: Resolve ComfyUI ref
        id: comfyui
        shell: bash
        run: |
          REF="${{ inputs.comfyui_ref }}"
          if [[ -z "$REF" ]]; then
            REF=$(curl -s https://api.github.com/repos/Comfy-Org/ComfyUI/releases/latest | jq -r '.tag_name')
            echo "Auto-detected latest stable release: $REF"
          fi
          echo "ref=$REF" >> "$GITHUB_OUTPUT"

      - name: Download python-build-standalone
        shell: bash
        run: |
          PYTHON_VER="${{ matrix.python_version || inputs.python_version }}"
          PBS_TAG="${{ inputs.pbs_release }}"
          ARCHIVE_NAME="cpython-${PYTHON_VER}+${PBS_TAG}-${{ matrix.python_platform }}-install_only.tar.gz"
          DOWNLOAD_URL="https://github.com/astral-sh/python-build-standalone/releases/download/${PBS_TAG}/${ARCHIVE_NAME}"

          echo "Downloading: ${DOWNLOAD_URL}"
          curl -L -o python-standalone.tar.gz "$DOWNLOAD_URL"
          mkdir python-extract
          tar -xzf python-standalone.tar.gz -C python-extract
          mv python-extract/python standalone-env

      - name: Clone ComfyUI
        uses: actions/checkout@v4
        with:
          repository: Comfy-Org/ComfyUI
          ref: ${{ steps.comfyui.outputs.ref }}
          path: ComfyUI

      - name: Fetch and prepare requirements
        shell: bash
        run: |
          # Build final requirements: vendor-specific + ComfyUI deps
          cp "${{ matrix.vendor_requirements }}" requirements_final.txt
          echo "-r ComfyUI/requirements.txt" >> requirements_final.txt

          echo "=== requirements_final.txt ==="
          cat requirements_final.txt

      - name: Install dependencies into standalone Python
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            PYTHON="standalone-env/python.exe"
          else
            PYTHON="standalone-env/bin/python3"
            chmod +x "$PYTHON"
          fi

          "$PYTHON" -m ensurepip --upgrade 2>/dev/null || true
          "$PYTHON" -m pip install --upgrade pip
          "$PYTHON" -m pip install --no-cache-dir -r requirements_final.txt pygit2

      - name: Bundle uv
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            UV_ARCHIVE="uv-x86_64-pc-windows-msvc.zip"
            curl -L -o uv.zip "https://github.com/astral-sh/uv/releases/latest/download/${UV_ARCHIVE}"
            unzip uv.zip -d uv-extract
            cp uv-extract/uv.exe standalone-env/
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            UV_ARCHIVE="uv-aarch64-apple-darwin.tar.gz"
            curl -L -o uv.tar.gz "https://github.com/astral-sh/uv/releases/latest/download/${UV_ARCHIVE}"
            mkdir -p uv-extract && tar -xzf uv.tar.gz -C uv-extract --strip-components=1
            cp uv-extract/uv standalone-env/bin/
          else
            UV_ARCHIVE="uv-x86_64-unknown-linux-gnu.tar.gz"
            curl -L -o uv.tar.gz "https://github.com/astral-sh/uv/releases/latest/download/${UV_ARCHIVE}"
            mkdir -p uv-extract && tar -xzf uv.tar.gz -C uv-extract --strip-components=1
            cp uv-extract/uv standalone-env/bin/
          fi
          rm -rf uv.zip uv.tar.gz uv-extract

      - name: Strip unnecessary files
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            SITE_PACKAGES="standalone-env/Lib/site-packages"
          else
            SITE_PACKAGES=$(find standalone-env/lib -name site-packages -type d | head -1)
          fi
          echo "Stripping from: $SITE_PACKAGES"

          # Remove unnecessary lib files (Windows .lib, Linux/Mac .a)
          rm -f "$SITE_PACKAGES/torch/lib/"*.lib 2>/dev/null || true
          find "$SITE_PACKAGES" -name "*.a" -delete 2>/dev/null || true

          # Remove C++ headers and cmake files
          rm -rf "$SITE_PACKAGES/torch/include" 2>/dev/null || true
          rm -rf "$SITE_PACKAGES/torch/share" 2>/dev/null || true

          # Remove unused torch components
          rm -rf "$SITE_PACKAGES/caffe2" 2>/dev/null || true
          rm -rf "$SITE_PACKAGES/torch/_inductor/autoheuristic/datasets" 2>/dev/null || true

          # Remove test directories from known large packages
          rm -rf "$SITE_PACKAGES/torch/testing/_internal" 2>/dev/null || true
          rm -rf "$SITE_PACKAGES/torch/test" 2>/dev/null || true
          rm -rf "$SITE_PACKAGES/transformers/tests" 2>/dev/null || true
          rm -rf "$SITE_PACKAGES/numpy/tests" 2>/dev/null || true
          rm -rf "$SITE_PACKAGES/PIL/tests" 2>/dev/null || true
          rm -rf "$SITE_PACKAGES/scipy/tests" 2>/dev/null || true

          # Remove __pycache__ and .pyc files
          find standalone-env -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find standalone-env -name "*.pyc" -delete 2>/dev/null || true

          # Strip debug symbols from shared libraries (Linux/Mac)
          if [[ "${{ runner.os }}" != "Windows" ]]; then
            find standalone-env -name "*.so" -exec strip --strip-debug {} \; 2>/dev/null || true
            find standalone-env -name "*.dylib" -exec strip -x {} \; 2>/dev/null || true
          fi

          echo "=== Largest directories in site-packages ==="
          du -sh "$SITE_PACKAGES"/*/ 2>/dev/null | sort -rh | head -20
          echo "=== Final environment size ==="
          du -sh standalone-env

      - name: Smoke test stripped environment
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            PYTHON="standalone-env/python.exe"
          else
            PYTHON="standalone-env/bin/python3"
          fi

          echo "=== Verifying core imports ==="
          "$PYTHON" -c "
          import torch
          print(f'torch {torch.__version__}')
          import tqdm
          print(f'tqdm {tqdm.__version__}')
          import transformers
          print(f'transformers {transformers.__version__}')
          import pygit2
          print(f'pygit2 {pygit2.__version__}')
          print('All core imports OK')
          "

      - name: Generate build manifest
        shell: bash
        run: |
          COMFYUI_COMMIT=$(git -C ComfyUI rev-parse HEAD)
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            PYTHON="standalone-env/python.exe"
            UV_VERSION=$(standalone-env/uv.exe --version | awk '{print $2}')
          else
            PYTHON="standalone-env/bin/python3"
            UV_VERSION=$(standalone-env/bin/uv --version | awk '{print $2}')
          fi
          PYTHON_VER="${{ matrix.python_version || inputs.python_version }}"
          TORCH_VERSION=$("$PYTHON" -c "import torch; print(torch.__version__)")
          BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          ARCHIVE_BASE="comfyui-standalone-${{ matrix.id }}-${{ steps.comfyui.outputs.ref }}"
          if [[ "${{ runner.os }}" == "macOS" ]]; then
            FILENAME="${ARCHIVE_BASE}.tar.gz"
          else
            FILENAME="${ARCHIVE_BASE}.7z"
          fi
          "$PYTHON" -c "
          import json, pathlib
          vendor_req = pathlib.Path('${{ matrix.vendor_requirements }}').read_text().strip()
          comfyui_req = pathlib.Path('ComfyUI/requirements.txt').read_text().strip()
          manifest = {
              'id': '${{ matrix.id }}',
              'filename': '${FILENAME}',
              'comfyui_ref': '${{ steps.comfyui.outputs.ref }}',
              'comfyui_commit': '${COMFYUI_COMMIT}',
              'python_version': '${PYTHON_VER}',
              'torch_version': '${TORCH_VERSION}',
              'pbs_release': '${{ inputs.pbs_release }}',
              'uv_version': '${UV_VERSION}',
              'vendor_requirements': '${{ matrix.vendor_requirements }}',
              'vendor_requirements_content': vendor_req,
              'comfyui_requirements_content': comfyui_req,
              'build_date': '${BUILD_DATE}',
          }
          print(json.dumps(manifest, indent=2))
          " > manifest.json
          echo "=== manifest.json ==="
          cat manifest.json

      - name: Package archive
        shell: bash
        run: |
          ARCHIVE_BASE="comfyui-standalone-${{ matrix.id }}-${{ steps.comfyui.outputs.ref }}"
          if [[ "${{ runner.os }}" == "macOS" ]]; then
            tar -czf "${ARCHIVE_BASE}.tar.gz" standalone-env ComfyUI manifest.json "${{ matrix.vendor_requirements }}"
          else
            7z a -t7z -m0=lzma2 -mx=9 -mfb=128 -md=768m -ms=on -mf=BCJ2 \
              "${ARCHIVE_BASE}.7z" standalone-env ComfyUI manifest.json "${{ matrix.vendor_requirements }}"
          fi

      - name: Report archive size
        shell: bash
        run: |
          ls -lh comfyui-standalone-${{ matrix.id }}-${{ steps.comfyui.outputs.ref }}.*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: manifest-${{ matrix.id }}
          path: manifest.json

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_type == 'tag' && github.ref_name || inputs.release_tag }}
          files: comfyui-standalone-${{ matrix.id }}-${{ steps.comfyui.outputs.ref }}.*
          fail_on_unmatched_files: false
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-manifests:
    needs: build
    runs-on: ubuntu-latest
    name: Publish manifests
    steps:
      - name: Download all manifests
        uses: actions/download-artifact@v4
        with:
          pattern: manifest-*

      - name: Combine manifests
        shell: bash
        run: |
          python -c "
          import json, glob
          manifests = []
          for f in sorted(glob.glob('manifest-*/manifest.json')):
              with open(f) as fh:
                  manifests.append(json.load(fh))
          print(json.dumps(manifests, indent=2))
          " > manifests.json
          echo "=== manifests.json ==="
          cat manifests.json

      - name: Upload manifests to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_type == 'tag' && github.ref_name || inputs.release_tag }}
          files: manifests.json
          fail_on_unmatched_files: false
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
