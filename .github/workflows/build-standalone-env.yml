name: Build Standalone Environment

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      python_version:
        description: "Python version (e.g. 3.12.12)"
        required: true
        default: "3.13.12"
      pbs_release:
        description: "python-build-standalone release tag (e.g. 20260211)"
        required: true
        default: "20260211"
      comfyui_ref:
        description: "ComfyUI branch/tag (leave empty for latest stable release)"
        required: false
        default: ""
      release_tag:
        description: "Tag for the GitHub Release to upload to"
        required: true
        default: "standalone-v0.1.0"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: win-nvidia-cu130
            vendor_requirements: requirements-nvidia.txt
          - id: win-nvidia-cu128
            vendor_requirements: requirements-nvidia-cu128.txt
          - id: win-nvidia-cu126
            vendor_requirements: requirements-nvidia-cu126.txt
          - id: win-intel-xpu
            vendor_requirements: requirements-intel.txt
          # AMD universal ROCm 7.2 package only provides Python 3.12 wheels
          - id: win-amd
            vendor_requirements: requirements-amd-win.txt
            python_version: "3.12.12"
          - id: win-cpu
            vendor_requirements: requirements-cpu.txt

    runs-on: windows-latest
    name: Build ${{ matrix.id }}

    steps:
      - name: Checkout launcher repo
        uses: actions/checkout@v4

      - name: Resolve ComfyUI ref
        id: comfyui
        shell: bash
        run: |
          REF="${{ inputs.comfyui_ref }}"
          if [[ -z "$REF" ]]; then
            REF=$(curl -s https://api.github.com/repos/Comfy-Org/ComfyUI/releases/latest | python -c "import sys,json; print(json.load(sys.stdin)['tag_name'])")
            echo "Auto-detected latest stable release: $REF"
          fi
          echo "ref=$REF" >> "$GITHUB_OUTPUT"

      - name: Download python-build-standalone
        shell: bash
        run: |
          PYTHON_VER="${{ matrix.python_version || inputs.python_version }}"
          PBS_TAG="${{ inputs.pbs_release }}"
          ARCHIVE_NAME="cpython-${PYTHON_VER}+${PBS_TAG}-x86_64-pc-windows-msvc-install_only.tar.gz"
          DOWNLOAD_URL="https://github.com/astral-sh/python-build-standalone/releases/download/${PBS_TAG}/${ARCHIVE_NAME}"

          echo "Downloading: ${DOWNLOAD_URL}"
          curl -L -o python-standalone.tar.gz "$DOWNLOAD_URL"
          mkdir python-extract
          tar -xzf python-standalone.tar.gz -C python-extract
          mv python-extract/python standalone-env

      - name: Clone ComfyUI
        uses: actions/checkout@v4
        with:
          repository: Comfy-Org/ComfyUI
          ref: ${{ steps.comfyui.outputs.ref }}
          path: ComfyUI

      - name: Fetch and prepare requirements
        shell: bash
        run: |
          # Build final requirements: vendor-specific + ComfyUI deps
          cp "${{ matrix.vendor_requirements }}" requirements_final.txt
          echo "-r ComfyUI/requirements.txt" >> requirements_final.txt

          echo "=== requirements_final.txt ==="
          cat requirements_final.txt

      - name: Install dependencies into standalone Python
        shell: bash
        run: |
          PYTHON="standalone-env/python.exe"

          "$PYTHON" -m ensurepip --upgrade 2>/dev/null || true
          "$PYTHON" -m pip install --upgrade pip
          "$PYTHON" -m pip install --no-cache-dir -r requirements_final.txt pygit2

      - name: Bundle uv
        shell: bash
        run: |
          curl -L -o uv.zip "https://github.com/astral-sh/uv/releases/latest/download/uv-x86_64-pc-windows-msvc.zip"
          unzip uv.zip -d uv-extract
          cp uv-extract/uv.exe standalone-env/
          rm -rf uv.zip uv-extract

      - name: Strip unnecessary files
        shell: bash
        run: |
          SITE_PACKAGES="standalone-env/Lib/site-packages"
          echo "Stripping from: $SITE_PACKAGES"

          # Remove large unnecessary torch files
          rm -f "$SITE_PACKAGES/torch/lib/dnnl.lib" 2>/dev/null || true
          rm -f "$SITE_PACKAGES/torch/lib/libprotoc.lib" 2>/dev/null || true
          rm -f "$SITE_PACKAGES/torch/lib/libprotobuf.lib" 2>/dev/null || true

          # Remove test directories
          find "$SITE_PACKAGES" -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
          find "$SITE_PACKAGES" -type d -name "test" -exec rm -rf {} + 2>/dev/null || true

          # Remove __pycache__
          find standalone-env -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true

          # Remove .dist-info
          find "$SITE_PACKAGES" -type d -name "*.dist-info" -exec rm -rf {} + 2>/dev/null || true

          echo "Final environment size:"
          du -sh standalone-env

      - name: Generate build manifest
        shell: bash
        run: |
          COMFYUI_COMMIT=$(git -C ComfyUI rev-parse HEAD)
          UV_VERSION=$(standalone-env/uv.exe --version | awk '{print $2}')
          PYTHON_VER="${{ matrix.python_version || inputs.python_version }}"
          BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          python -c "
          import json
          manifest = {
              'id': '${{ matrix.id }}',
              'comfyui_ref': '${{ steps.comfyui.outputs.ref }}',
              'comfyui_commit': '${COMFYUI_COMMIT}',
              'python_version': '${PYTHON_VER}',
              'pbs_release': '${{ inputs.pbs_release }}',
              'uv_version': '${UV_VERSION}',
              'vendor_requirements': '${{ matrix.vendor_requirements }}',
              'build_date': '${BUILD_DATE}',
          }
          print(json.dumps(manifest, indent=2))
          " > manifest.json
          echo "=== manifest.json ==="
          cat manifest.json

      - name: Package archive
        shell: bash
        run: |
          7z a -t7z -m0=lzma2 -mx=7 -ms=on \
            "comfyui-standalone-${{ matrix.id }}-${{ steps.comfyui.outputs.ref }}.7z" \
            standalone-env ComfyUI manifest.json

      - name: Report archive size
        shell: bash
        run: |
          ls -lh comfyui-standalone-${{ matrix.id }}-${{ steps.comfyui.outputs.ref }}.7z

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: manifest-${{ matrix.id }}
          path: manifest.json

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name || inputs.release_tag }}
          files: comfyui-standalone-${{ matrix.id }}-${{ steps.comfyui.outputs.ref }}.7z
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-manifests:
    needs: build
    runs-on: ubuntu-latest
    name: Publish manifests
    steps:
      - name: Download all manifests
        uses: actions/download-artifact@v4
        with:
          pattern: manifest-*

      - name: Combine manifests
        shell: bash
        run: |
          python -c "
          import json, glob
          manifests = []
          for f in sorted(glob.glob('manifest-*/manifest.json')):
              with open(f) as fh:
                  manifests.append(json.load(fh))
          print(json.dumps(manifests, indent=2))
          " > manifests.json
          echo "=== manifests.json ==="
          cat manifests.json

      - name: Upload manifests to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name || inputs.release_tag }}
          files: manifests.json
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
